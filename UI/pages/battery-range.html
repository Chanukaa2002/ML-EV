<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Range Calculator - EV Route Optimizer</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Sidebar (same as other pages) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"></path>
            </svg>
            <span>EV Optimizer</span>
        </div>

        <nav>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="../index.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="trip-planner.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Trip Planner</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="driving-style.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>Driving Style</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="battery-range.html" class="sidebar-nav-link active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="10" rx="2"></rect>
                            <line x1="22" y1="11" x2="22" y2="13"></line>
                        </svg>
                        <span>Battery Range</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="route-optimizer.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v4a1 1 0 0 0 1 1h3"></path>
                            <path d="M7 7v10"></path>
                            <path d="M10 8v8a1 1 0 0 0 1 1h2a1 1 0 0 0 1 -1v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1z"></path>
                            <path d="M17 7v4a1 1 0 0 0 1 1h3"></path>
                            <path d="M21 7v10"></path>
                        </svg>
                        <span>Route Optimizer</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="energy-consumption.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                        </svg>
                        <span>Energy Consumption</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-primary" style="font-size: 2rem; margin-bottom: 0.5rem;">Battery Range Calculator</h1>
                    <p class="text-secondary">Calculate your EV's range under different conditions</p>
                </div>
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            </div>
        </header>

        <div id="error-container"></div>
        <div id="success-container"></div>

        <div class="grid grid-cols-2">
            <!-- Calculator Form -->
            <div class="card">
                <div class="card-header">
                    <h3>Range Calculator</h3>
                </div>
                <div class="card-body">
                    <form id="range-form" onsubmit="calculateRange(event)">
                        <div class="form-group">
                            <label class="form-label">Vehicle Model</label>
                            <select id="vehicle-select" class="form-select" onchange="updateVehicleInfo()" required>
                                <option value="">-- Select Vehicle --</option>
                            </select>
                        </div>

                        <div id="vehicle-info" class="card mb-3" style="display: none;">
                            <div class="card-body">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <p class="text-muted" style="margin: 0; font-size: 0.875rem;">Battery Capacity</p>
                                        <p id="battery-capacity" style="margin: 0; font-weight: 600;">-- kWh</p>
                                    </div>
                                    <div>
                                        <p class="text-muted" style="margin: 0; font-size: 0.875rem;">Rated Range</p>
                                        <p id="rated-range" style="margin: 0; font-weight: 600;">-- km</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Current Battery Level (%)</label>
                            <input type="number" id="battery-level" class="form-control" min="0" max="100" value="100" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Driving Style</label>
                            <select id="driving-style" class="form-select" required>
                                <option value="Eco">üå± Eco (Best Range)</option>
                                <option value="Normal" selected>üöó Normal (Balanced)</option>
                                <option value="Aggressive">üèéÔ∏è Aggressive (Reduced Range)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Temperature (¬∞C)</label>
                            <input type="number" id="temperature" class="form-control" min="-20" max="50" value="25" required>
                            <small class="text-muted">Extreme temperatures affect range</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Terrain</label>
                            <select id="terrain" class="form-select" required>
                                <option value="flat">‚¨ÜÔ∏è Flat (Best Range)</option>
                                <option value="mixed" selected>‚ÜóÔ∏è Mixed (Moderate)</option>
                                <option value="hilly">‚õ∞Ô∏è Hilly (Reduced Range)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">AC/Climate Control</label>
                            <select id="climate" class="form-select" required>
                                <option value="off">Off</option>
                                <option value="eco">Eco Mode</option>
                                <option value="normal" selected>Normal</option>
                                <option value="max">Maximum</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            üîã Calculate Range
                        </button>
                    </form>
                </div>
            </div>

            <!-- Results -->
            <div class="card">
                <div class="card-header">
                    <h3>Estimated Range</h3>
                </div>
                <div class="card-body">
                    <div id="range-results">
                        <div class="text-center text-muted" style="padding: 3rem;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem;">
                                <rect x="2" y="7" width="20" height="10" rx="2"></rect>
                                <line x1="22" y1="11" x2="22" y2="13"></line>
                            </svg>
                            <p>Select your vehicle and conditions to calculate estimated range</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Range Comparison Table -->
        <div class="card mt-4">
            <div class="card-header">
                <h3>Vehicle Comparison</h3>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle Model</th>
                                <th>Battery Capacity</th>
                                <th>Consumption</th>
                                <th>Rated Range</th>
                                <th>Eco Range</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/constants.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let selectedVehicle = null;

        document.addEventListener('DOMContentLoaded', function() {
            populateSelect('vehicle-select', VEHICLE_MODELS, 'name', 'name');
            populateComparisonTable();
        });

        function updateVehicleInfo() {
            const vehicleName = document.getElementById('vehicle-select').value;
            selectedVehicle = VEHICLE_MODELS.find(v => v.name === vehicleName);

            if (selectedVehicle) {
                document.getElementById('vehicle-info').style.display = 'block';
                document.getElementById('battery-capacity').textContent = selectedVehicle.batteryCapacity + ' kWh';
                document.getElementById('rated-range').textContent = selectedVehicle.range + ' km';
            } else {
                document.getElementById('vehicle-info').style.display = 'none';
            }
        }

        async function calculateRange(event) {
            event.preventDefault();

            if (!selectedVehicle) {
                showError('Please select a vehicle');
                return;
            }

            const batteryLevel = parseFloat(document.getElementById('battery-level').value);
            const drivingStyle = document.getElementById('driving-style').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const terrain = document.getElementById('terrain').value;
            const climate = document.getElementById('climate').value;

            try {
                showLoading('range-results');

                // Step 1: Get energy efficiency from energy prediction API
                // We'll use a standard 100km trip to get the efficiency
                const energyData = {
                    distance_km: 100,
                    driving_style: drivingStyle,
                    road_type: terrain === 'flat' ? 'highway' : terrain === 'hilly' ? 'rural' : 'city',
                    weather: temperature < 10 ? 'light_rain' : 'sunny',
                    elevation_gain_m: terrain === 'hilly' ? 200 : 0,
                    avg_speed: drivingStyle === 'Eco' ? 60 : drivingStyle === 'Aggressive' ? 90 : 70
                };

                const energyResult = await energyAPI.predictConsumption(energyData);

                if (!energyResult.success) {
                    throw new Error(energyResult.error || 'Energy prediction failed');
                }

                // Step 2: Use battery range API with the predicted efficiency
                const batteryData = {
                    battery_capacity_kWh: selectedVehicle.batteryCapacity,
                    battery_percent: batteryLevel,
                    efficiency_kWh_per_km: energyResult.efficiency_kWh_per_km
                };

                const rangeResult = await batteryAPI.predictRange(batteryData);

                if (!rangeResult.success) {
                    throw new Error(rangeResult.error || 'Range prediction failed');
                }

                const estimatedRange = rangeResult.predicted_range_km;
                const baseRange = selectedVehicle.range * (batteryLevel / 100);

                displayResults({
                    estimatedRange,
                    baseRange,
                    theoreticalRange: rangeResult.theoretical_range_km,
                    availableEnergy: rangeResult.available_energy_kWh,
                    batteryLevel,
                    drivingStyle,
                    temperature,
                    terrain,
                    climate,
                    efficiency: energyResult.efficiency_kWh_per_km,
                    energyResult,
                    rangeResult
                });

                showSuccess('Range predicted by AI models');

            } catch (error) {
                console.error('Range calculation error:', error);
                showError('Failed to calculate range: ' + error.message);
                document.getElementById('range-results').innerHTML =
                    `<div class="card"><div class="card-body"><p class="text-danger">Error: ${error.message}</p></div></div>`;
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('range-results');

            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üîã</div>
                    <h2 style="color: var(--primary); margin-bottom: 0.5rem;">${formatDistance(data.estimatedRange)}</h2>
                    <p class="text-secondary">AI Predicted Range</p>

                    <div style="margin: 2rem 0;">
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar" style="width: ${(data.estimatedRange / selectedVehicle.range) * 100}%;"></div>
                        </div>
                        <div class="flex justify-between mt-1 text-muted" style="font-size: 0.875rem;">
                            <span>0 km</span>
                            <span>${selectedVehicle.range} km (Rated)</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Base Range (${data.batteryLevel}%)</p>
                                <h3 style="margin: 0;">${formatDistance(data.baseRange)}</h3>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Available Energy</p>
                                <h3 style="margin: 0;">${data.availableEnergy.toFixed(1)} kWh</h3>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Efficiency (AI)</p>
                                <h3 style="margin: 0;">${data.efficiency.toFixed(3)} kWh/km</h3>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Theoretical Range</p>
                                <h3 style="margin: 0;">${formatDistance(data.theoreticalRange)}</h3>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body">
                            <p class="text-muted mb-2"><strong>ü§ñ AI Analysis Factors:</strong></p>
                            <div class="grid gap-2">
                                <div class="flex justify-between items-center">
                                    <span>Driving Style</span>
                                    <strong>${data.drivingStyle}</strong>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Temperature</span>
                                    <strong>${data.temperature}¬∞C</strong>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Terrain</span>
                                    <strong>${data.terrain}</strong>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Climate Control</span>
                                    <strong>${data.climate}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <p class="text-muted mb-1">Total Impact</p>
                                <h3 style="margin: 0; color: ${impactPercent >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${impactPercent > 0 ? '+' : ''}${impactPercent}%
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body text-left">
                            <p class="text-muted mb-2"><strong>Condition Impacts:</strong></p>
                            <div class="grid gap-2">
                                <div class="flex justify-between items-center">
                                    <span>${data.drivingStyle} Driving</span>
                                    <span class="${data.multipliers.style >= 1 ? 'text-success' : 'text-danger'}">
                                        ${((data.multipliers.style - 1) * 100).toFixed(0)}%
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>${data.temperature}¬∞C Temperature</span>
                                    <span class="${data.multipliers.temp >= 1 ? 'text-success' : 'text-danger'}">
                                        ${((data.multipliers.temp - 1) * 100).toFixed(0)}%
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>${data.terrain.charAt(0).toUpperCase() + data.terrain.slice(1)} Terrain</span>
                                    <span class="${data.multipliers.terrain >= 1 ? 'text-success' : 'text-danger'}">
                                        ${((data.multipliers.terrain - 1) * 100).toFixed(0)}%
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Climate: ${data.climate}</span>
                                    <span class="${data.multipliers.climate >= 1 ? 'text-success' : 'text-danger'}">
                                        ${((data.multipliers.climate - 1) * 100).toFixed(0)}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${getRecommendations(data)}
                </div>
            `;
        }

        function getRecommendations(data) {
            const recs = [];

            if (data.drivingStyle === 'Aggressive') {
                recs.push('Switch to Eco mode for 15% more range');
            }
            if (data.temperature < 10 || data.temperature > 35) {
                recs.push('Pre-condition vehicle while charging');
            }
            if (data.climate === 'max') {
                recs.push('Use Eco climate mode to save energy');
            }
            if (data.batteryLevel < 30) {
                recs.push('Charge before long trips for optimal range');
            }

            if (recs.length === 0) {
                recs.push('Conditions are optimal for maximum range');
            }

            return `
                <div class="card mt-3">
                    <div class="card-body text-left">
                        <p class="text-muted mb-2"><strong>üí° Tips to Improve Range:</strong></p>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            ${recs.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        function populateComparisonTable() {
            const tbody = document.getElementById('comparison-table');
            tbody.innerHTML = '';

            VEHICLE_MODELS.forEach(vehicle => {
                const ecoRange = vehicle.range * 1.15;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${vehicle.name}</strong></td>
                    <td>${vehicle.batteryCapacity} kWh</td>
                    <td>${vehicle.consumption} kWh/km</td>
                    <td>${vehicle.range} km</td>
                    <td class="text-success">${formatDistance(ecoRange)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
    </script>
</body>

</html>
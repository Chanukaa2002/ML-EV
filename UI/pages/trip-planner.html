<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner - EV Route Optimizer</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"></path>
            </svg>
            <span>EV Optimizer</span>
        </div>

        <nav>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="../index.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="trip-planner.html" class="sidebar-nav-link active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Trip Planner</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="driving-style.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>Driving Style</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="battery-range.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="10" rx="2"></rect>
                            <line x1="22" y1="11" x2="22" y2="13"></line>
                        </svg>
                        <span>Battery Range</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="route-optimizer.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 7v4a1 1 0 0 0 1 1h3"></path>
                            <path d="M7 7v10"></path>
                            <path d="M10 8v8a1 1 0 0 0 1 1h2a1 1 0 0 0 1 -1v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1z"></path>
                            <path d="M17 7v4a1 1 0 0 0 1 1h3"></path>
                            <path d="M21 7v10"></path>
                        </svg>
                        <span>Route Optimizer</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="energy-consumption.html" class="sidebar-nav-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline>
                        </svg>
                        <span>Energy Consumption</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-primary" style="font-size: 2rem; margin-bottom: 0.5rem;">Trip Planner</h1>
                    <p class="text-secondary">Plan your EV trip with intelligent predictions</p>
                </div>
                <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
            </div>
        </header>

        <div id="error-container"></div>
        <div id="success-container"></div>

        <!-- Progress Steps -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="flex justify-between items-center" id="progress-steps">
                    <div class="flex items-center gap-2 step active" data-step="1">
                        <div class="step-number">1</div>
                        <span>Route Details</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="flex items-center gap-2 step" data-step="2">
                        <div class="step-number">2</div>
                        <span>Driving Data</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="flex items-center gap-2 step" data-step="3">
                        <div class="step-number">3</div>
                        <span>Results</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Route Details -->
        <div class="card step-content" id="step-1">
            <div class="card-header">
                <h3>Step 1: Enter Route Details</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">From City</label>
                        <select id="from-city" class="form-select" required>
                            <option value="">-- Select City --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">To City</label>
                        <select id="to-city" class="form-select" required>
                            <option value="">-- Select City --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Vehicle Model</label>
                        <select id="vehicle-model" class="form-select" required>
                            <option value="">-- Select Vehicle --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Battery (%)</label>
                        <input type="number" id="current-battery" class="form-control" min="0" max="100" value="80" required>
                    </div>
                </div>

                <div id="route-info" class="mt-3"></div>

                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" disabled>← Previous</button>
                    <button class="btn btn-primary" onclick="goToStep(2)">Next →</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Driving Data -->
        <div class="card step-content hidden" id="step-2">
            <div class="card-header">
                <h3>Step 2: Enter Driving Metrics</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>Enter your typical driving patterns for accurate predictions</span>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Average Speed (km/h)</label>
                        <input type="number" id="avg-speed" class="form-control" min="0" max="200" value="60" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Speed (km/h)</label>
                        <input type="number" id="max-speed" class="form-control" min="0" max="200" value="80" required>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Average Acceleration (m/s²)</label>
                        <input type="number" id="avg-accel" class="form-control" step="0.1" min="0" max="10" value="2.0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Average Braking (m/s²)</label>
                        <input type="number" id="avg-brake" class="form-control" step="0.1" min="0" max="10" value="2.5" required>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Idle Time (%)</label>
                        <input type="number" id="idle-time" class="form-control" min="0" max="100" value="15" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trip Duration (hours)</label>
                        <input type="number" id="trip-duration" class="form-control" step="0.5" min="0.5" max="24" value="2" required>
                    </div>
                </div>

                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="goToStep(1)">← Previous</button>
                    <button class="btn btn-primary" onclick="calculateTrip()">Calculate Trip →</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="card step-content hidden" id="step-3">
            <div class="card-header">
                <h3>Step 3: Trip Analysis Results</h3>
            </div>
            <div class="card-body">
                <div id="results-container">
                    <!-- Results will be populated here -->
                </div>

                <div class="flex justify-between mt-4">
                    <button class="btn btn-secondary" onclick="goToStep(2)">← Previous</button>
                    <button class="btn btn-success" onclick="saveTripAndReset()">Save Trip & New Plan</button>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/constants.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let tripData = {};
        let weatherData = null;
        let drivingPrediction = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeTripPlanner();
        });

        function initializeTripPlanner() {
            populateSelect('from-city', SRI_LANKAN_CITIES, 'name', 'name');
            populateSelect('to-city', SRI_LANKAN_CITIES, 'name', 'name');
            populateSelect('vehicle-model', VEHICLE_MODELS, 'name', 'name');

            // Add change listeners
            document.getElementById('from-city').addEventListener('change', updateRouteInfo);
            document.getElementById('to-city').addEventListener('change', updateRouteInfo);
        }

        function updateRouteInfo() {
            const fromCity = document.getElementById('from-city').value;
            const toCity = document.getElementById('to-city').value;
            const infoDiv = document.getElementById('route-info');

            if (!fromCity || !toCity) {
                infoDiv.innerHTML = '';
                return;
            }

            if (fromCity === toCity) {
                infoDiv.innerHTML = '<p class="text-danger">Please select different cities</p>';
                return;
            }

            const fromCoords = getCityCoordinates(fromCity);
            const toCoords = getCityCoordinates(toCity);
            const distance = calculateDistance(fromCoords.lat, fromCoords.lon, toCoords.lat, toCoords.lon);

            infoDiv.innerHTML = `
                <div class="alert alert-info">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span><strong>Estimated Distance:</strong> ${formatDistance(distance)}</span>
                </div>
            `;

            tripData.fromCity = fromCity;
            tripData.toCity = toCity;
            tripData.distance = distance;
            tripData.fromCoords = fromCoords;
            tripData.toCoords = toCoords;
        }

        function goToStep(stepNumber) {
            // Validate current step
            if (stepNumber === 2 && !validateStep1()) return;
            if (stepNumber === 3 && !validateStep2()) return;

            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));

            // Show target step
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');

            // Update progress
            document.querySelectorAll('.step').forEach((el, index) => {
                if (index + 1 <= stepNumber) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        function validateStep1() {
            const fromCity = document.getElementById('from-city').value;
            const toCity = document.getElementById('to-city').value;
            const vehicle = document.getElementById('vehicle-model').value;
            const battery = document.getElementById('current-battery').value;

            if (!fromCity || !toCity || !vehicle || !battery) {
                showError('Please fill in all required fields');
                return false;
            }

            if (fromCity === toCity) {
                showError('Please select different cities');
                return false;
            }

            tripData.vehicle = vehicle;
            tripData.batteryLevel = parseFloat(battery);

            return true;
        }

        function validateStep2() {
            const avgSpeed = document.getElementById('avg-speed').value;
            const maxSpeed = document.getElementById('max-speed').value;
            const avgAccel = document.getElementById('avg-accel').value;
            const avgBrake = document.getElementById('avg-brake').value;
            const idleTime = document.getElementById('idle-time').value;
            const duration = document.getElementById('trip-duration').value;

            if (!avgSpeed || !maxSpeed || !avgAccel || !avgBrake || !idleTime || !duration) {
                showError('Please fill in all driving metrics');
                return false;
            }

            return true;
        }

        async function calculateTrip() {
            if (!validateStep2()) return;

            showLoading('results-container');
            goToStep(3);

            try {
                // 1. Fetch weather data
                const weatherPromise = weatherAPI.getWeather(
                    tripData.toCoords.lat,
                    tripData.toCoords.lon
                );

                // 2. Predict driving style - Transform to backend expected format
                const avgSpeed = parseFloat(document.getElementById('avg-speed').value);
                const maxSpeed = parseFloat(document.getElementById('max-speed').value);
                const avgAccel = parseFloat(document.getElementById('avg-accel').value);
                const avgBrake = parseFloat(document.getElementById('avg-brake').value);
                const idleTime = parseFloat(document.getElementById('idle-time').value);
                const duration = parseFloat(document.getElementById('trip-duration').value);

                // Transform simple inputs to backend's expected format with defaults
                const drivingData = {
                    distance_km: tripData.distance,
                    elevation_gain_m: 0, // Default
                    avg_speed: avgSpeed,
                    max_speed: maxSpeed,
                    acceleration_mean: avgAccel,
                    acceleration_std: avgAccel * 0.3, // Estimate
                    braking_intensity: avgBrake,
                    trip_duration_min: duration,
                    vehicle_make: "MG", // Default
                    vehicle_model: "ZS EV", // Default
                    road_type: "city", // Default
                    weather: "clear", // Default
                    time_of_day: "evening" // Default
                };

                const drivingPromise = drivingAPI.predictDrivingStyle(drivingData);

                // Wait for both
                const [weather, driving] = await Promise.all([weatherPromise, drivingPromise]);

                weatherData = weather;
                drivingPrediction = driving;

                // 3. Calculate energy consumption using backend API
                await calculateEnergyConsumption();

                // Display results
                displayResults();

            } catch (error) {
                console.error('Trip calculation error:', error);
                document.getElementById('results-container').innerHTML =
                    `<p class="text-danger">Error calculating trip: ${error.message}</p>`;
            }
        }

        async function calculateEnergyConsumption() {
            const vehicleData = VEHICLE_MODELS.find(v => v.name === tripData.vehicle);
            const distance = tripData.distance;
            const avgSpeed = parseFloat(document.getElementById('avg-speed').value);
            const drivingStyle = drivingPrediction.predicted_driving_style || 'Normal';

            try {
                // Call backend energy prediction API
                const energyData = {
                    distance_km: distance,
                    driving_style: drivingStyle,
                    road_type: "city", // Default
                    weather: "sunny", // Default - could use weatherData for better accuracy
                    elevation_gain_m: 0,
                    avg_speed: avgSpeed
                };

                const energyResult = await energyAPI.predictConsumption(energyData);

                if (!energyResult.success) {
                    throw new Error('Energy prediction failed');
                }

                const totalEnergy = energyResult.predicted_energy_kWh;
                const batteryUsed = (totalEnergy / vehicleData.batteryCapacity) * 100;
                const remainingBattery = tripData.batteryLevel - batteryUsed;

                tripData.energyConsumption = totalEnergy;
                tripData.batteryUsed = batteryUsed;
                tripData.remainingBattery = remainingBattery;
                tripData.drivingStyle = drivingStyle;
                tripData.efficiency = energyResult.efficiency_kWh_per_km;

            } catch (error) {
                console.error('Energy calculation error:', error);
                // Fallback to simple estimation if API fails
                const baseConsumption = distance * vehicleData.consumption;
                tripData.energyConsumption = baseConsumption;
                tripData.batteryUsed = (baseConsumption / vehicleData.batteryCapacity) * 100;
                tripData.remainingBattery = tripData.batteryLevel - tripData.batteryUsed;
                tripData.drivingStyle = drivingStyle;
            }
        }

        function displayResults() {
            const vehicleData = VEHICLE_MODELS.find(v => v.name === tripData.vehicle);
            const resultsDiv = document.getElementById('results-container');

            const weatherDesc = weatherData.weather ? .[0] ? .description || 'N/A';
            const temp = weatherData.main ? .temp || 'N/A';

            resultsDiv.innerHTML = `
                <!-- Summary Stats -->
                <div class="grid grid-cols-3 mb-4">
                    ${createStatCard('Trip Distance', formatDistance(tripData.distance), '📍')}
                    ${createStatCard('Energy Needed (AI)', formatEnergy(tripData.energyConsumption), '⚡')}
                    ${createStatCard('Battery Used', formatPercentage(tripData.batteryUsed), '🔋')}
                </div>

                <!-- Detailed Results -->
                <div class="grid grid-cols-2 gap-3">
                    <!-- Route Info -->
                    <div class="card">
                        <div class="card-header">
                            <h4 style="margin: 0; font-size: 1rem;">Route Details</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>From:</strong> ${tripData.fromCity}</p>
                            <p><strong>To:</strong> ${tripData.toCity}</p>
                            <p><strong>Distance:</strong> ${formatDistance(tripData.distance)}</p>
                            <p><strong>Vehicle:</strong> ${tripData.vehicle}</p>
                        </div>
                    </div>

                    <!-- Weather Impact -->
                    <div class="card">
                        <div class="card-header">
                            <h4 style="margin: 0; font-size: 1rem;">Weather Conditions</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>Temperature:</strong> ${temp}°C</p>
                            <p><strong>Conditions:</strong> ${weatherDesc}</p>
                            <p class="text-muted" style="margin: 0; font-size: 0.875rem;">Weather data from live API</p>
                        </div>
                    </div>

                    <!-- Driving Style -->
                    <div class="card">
                        <div class="card-header">
                            <h4 style="margin: 0; font-size: 1rem;">🤖 AI Driving Analysis</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>Predicted Style:</strong> ${getDrivingStyleBadge(tripData.drivingStyle)}</p>
                            <p><strong>Confidence:</strong> ${formatPercentage((drivingPrediction.confidence_score || 0) * 100)}</p>
                            <p><strong>Efficiency:</strong> ${tripData.efficiency ? tripData.efficiency.toFixed(3) + ' kWh/km' : 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Battery Status -->
                    <div class="card">
                        <div class="card-header">
                            <h4 style="margin: 0; font-size: 1rem;">Battery Status</h4>
                        </div>
                        <div class="card-body">
                            <p><strong>Starting:</strong> ${formatPercentage(tripData.batteryLevel)}</p>
                            <p><strong>Used:</strong> ${formatPercentage(tripData.batteryUsed)}</p>
                            <p><strong>Remaining:</strong> 
                                <span class="${tripData.remainingBattery < 20 ? 'text-danger' : tripData.remainingBattery < 40 ? 'text-warning' : 'text-success'}">
                                    ${formatPercentage(tripData.remainingBattery)}
                                </span>
                            </p>
                            ${tripData.remainingBattery < 20 ? 
                                '<p class="text-danger mt-2"><strong>⚠️ Warning:</strong> Low battery at destination! Plan charging stops.</p>' : ''}
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h4 style="margin: 0; font-size: 1rem;">🤖 AI-Powered Recommendations</h4>
                    </div>
                    <div class="card-body">
                        ${getRecommendations()}
                    </div>
                </div>
            `;
        }

        function getRecommendations() {
            const recommendations = [];

            if (tripData.remainingBattery < 20) {
                recommendations.push('🔴 <strong>Critical:</strong> Plan charging stops along the route');
            } else if (tripData.remainingBattery < 40) {
                recommendations.push('🟡 <strong>Caution:</strong> Consider charging before the trip');
            }

            if (tripData.drivingStyle === 'Aggressive') {
                recommendations.push('🚗 <strong>Driving:</strong> Reduce aggressive driving to save 15-30% energy');
            }

            if (tripData.weatherMultiplier > 1.1) {
                recommendations.push('🌡️ <strong>Weather:</strong> Extreme temperatures detected, expect higher consumption');
            }

            if (recommendations.length === 0) {
                recommendations.push('✅ <strong>All Good!</strong> Your trip should complete comfortably');
            }

            return '<ul>' + recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>';
        }

        function saveTripAndReset() {
            // Save trip to localStorage
            const trips = getFromStorage('trips') || [];
            trips.push({
                route: `${tripData.fromCity} → ${tripData.toCity}`,
                distance: tripData.distance.toFixed(1),
                energy: tripData.energyConsumption.toFixed(2),
                energySaved: tripData.drivingStyle === 'Eco' ? tripData.energyConsumption * 0.15 : 0,
                range: tripData.distance,
                date: formatDateTime()
            });
            saveToStorage('trips', trips);

            showSuccess('Trip saved successfully!');

            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
    </script>

    <style>
        .step {
            flex: 1;
            opacity: 0.5;
            transition: var(--transition);
        }
        
        .step.active {
            opacity: 1;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .step.active .step-number {
            background: var(--primary);
            color: white;
        }
        
        .progress-line {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            margin: 0 1rem;
        }
    </style>
</body>

</html>